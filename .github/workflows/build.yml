name: build
on:
  push:
    branches:
      - trunk
  pull_request:
  schedule:
    # Nightly builds against react-native@nightly at 5:00
    - cron: 0 5 * * *
env:
  HOMEBREW_NO_INSTALL_CLEANUP: 1
jobs:
  ios:
    name: "iOS"
    runs-on: macos-12
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up toolchain
        uses: ./.github/actions/setup-toolchain
        with:
          platform: ios
          variant: example
      - name: Set up react-native@nightly
        run: |
          # `nightly` currently doesn't build due to use of version numbers that
          # are incompatible with CocoaPods. See
          # https://github.com/facebook/react-native/issues/30036 and
          # https://github.com/microsoft/react-native-macos/issues/620 for more
          # details.
          npm run set-react-version -- main
          rm example/ios/Podfile.lock
      - name: Install npm dependencies
        uses: ./.github/actions/yarn
        with:
          immutable: false
      - name: Install Pods
        uses: ./.github/actions/cocoapods
        with:
          project-directory: ios
          working-directory: example
      - name: Build
        run: |
          ../scripts/xcodebuild.sh ios/Example.xcworkspace build-for-testing
        working-directory: example
    timeout-minutes: 60

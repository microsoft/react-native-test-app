name: build
on:
  push:
    branches:
      - master
  pull_request:
jobs:
  lint-test:
    name: "lint + test"
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: CocoaPods
        run: |
          bundle install
          echo "::add-matcher::.github/rubocop.json"
          bundle exec rubocop
          echo "::remove-matcher owner=rubocop::"
          echo "::add-matcher::.github/minitest.json"
          bundle exec ruby -Ilib:test test/test_test_app.rb
          echo "::remove-matcher owner=minitest::"
      - name: JavaScript
        run: |
          yarn
          echo "::add-matcher::.github/eslint-stylish.json"
          yarn lint:js
          echo "::remove-matcher owner=eslint-stylish::"
  ios:
    name: "iOS"
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install
        run: |
          yarn
        working-directory: example
      - name: Build
        run: |
          set -eo pipefail
          yarn build:ios
          pod install --project-directory=ios
          ../scripts/xcodebuild-ios.sh ios/Example.xcworkspace build-for-testing
        working-directory: example
      - name: Test
        run: |
          ../scripts/xcodebuild-ios.sh ios/Example.xcworkspace test-without-building
        working-directory: example
  ios-template:
    name: "iOS [template: all]"
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install
        run: scripts/install-test-template.sh all
      - name: Build
        run: |
          set -eo pipefail
          yarn build:ios
          pod install --project-directory=ios
          ../scripts/xcodebuild-ios.sh ios/TemplateExample.xcworkspace build
        working-directory: template-example
  ios-template-exclusive:
    name: "iOS [template: ios]"
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install
        run: scripts/install-test-template.sh ios
      - name: Build
        run: |
          set -eo pipefail
          yarn build:ios
          pod install
          ../scripts/xcodebuild-ios.sh TemplateExample.xcworkspace build
        working-directory: template-example
  android:
    name: "Android"
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: Set up Node.js
        uses: actions/setup-node@v1
        with:
          # Node has a bug where it crashes compiling a regular
          # expression of react-native cli. Using a specific
          # Node version helps to workaround this problem:
          # https://github.com/facebook/react-native/issues/26598
          node-version: 12.9.1
      - name: Install
        run: |
          yarn
        working-directory: example
      - name: Build
        shell: bash
        run: |
          set -eo pipefail
          yarn build:android
          pushd android 1> /dev/null
          ./gradlew clean build check test
        working-directory: example
  android-template:
    name: "Android [template: all]"
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: Set up Node.js
        uses: actions/setup-node@v1
        with:
          # Node has a bug where it crashes compiling a regular
          # expression of react-native cli. Using a specific
          # Node version helps to workaround this problem:
          # https://github.com/facebook/react-native/issues/26598
          node-version: 12.9.1
      - name: Install
        run: scripts/install-test-template.sh all
        shell: bash
      - name: Build
        run: |
          set -eo pipefail
          yarn build:android
          pushd android 1> /dev/null
          ./gradlew clean build check test
        shell: bash
        working-directory: template-example
  android-template-exclusive:
    name: "Android [template: android]"
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: Set up Node
        uses: actions/setup-node@v1
        with:
          # Node has a bug where it crashes compiling a regular
          # expression of react-native cli. Using a specific
          # Node version helps to workaround this problem:
          # https://github.com/facebook/react-native/issues/26598
          node-version: 12.9.1
      - name: Install
        run: scripts/install-test-template.sh android
        shell: bash
      - name: Build
        run: |
          set -eo pipefail
          yarn build:android
          ./gradlew clean build check test
        shell: bash
        working-directory: template-example
  release:
    needs:
      [
        lint-test,
        ios,
        ios-template,
        ios-template-exclusive,
        android,
        android-template,
        android-template-exclusive,
      ]
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 12
      - name: Install
        run: |
          yarn link
          pushd example 1> /dev/null
          yarn
          yarn link react-native-test-app
          pod install --project-directory=ios
          popd 1> /dev/null
          yarn
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npx semantic-release
